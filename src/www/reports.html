<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <link rel="stylesheet" href="/www/style.css"/>
      <script type="text/javascript" src="/www/jquery.js"></script>
      <script type="text/javascript">
      function apply_types(data)
      {
         $("#lv_types").children().remove();
         $("#lv_types").text("Types: ");
         $.each(data, function(i, type)
         {
            $("#lv_types").append($("<input type='checkbox'>").val(type).attr("checked", true));
            $("#lv_types").append($("<label>").text(type));
         });
      }
      function apply_pages(pages, selPage)
      {
         $("#lv_pages").children().remove();
         $.each(pages, function(i, page)
         {
            if (selPage == page)
            {
               $("#lv_pages").append($("<label>" + page + "</label>"));
            }
            else
            {
               $("#lv_pages").append($("<a href=\"#\">" + page + "</a>").click(function(){get_records(page)}));
            }
            $("#lv_pages").append($("<label>&nbsp;</label>"));
         });
      }
      function apply_records(records)
      {
         $("#lv_records").children().remove();
         $("#lv_records").append("<tr><th class=\"no_col\">No</th><th class=\"type_col\">Type</th><th class=\"pid_col\">Pid</th><th class=\"date_col\">Date</th></tr>");
         $.each(records, function(i, rec){
            var recClass = "";
            if (rec.type == "error" || rec.type == "error_report" || rec.type == "error_msg" || rec.type == "crash_report")
            {
               recClass = "error";
            }
            if (rec.type == rec.type == "warning" || rec.type == "warning_report" || rec.type == "warning_msg")
            {
               recClass = "warning";
            }
            else if (rec.type == "progress")
            {
               recClass = "progress";
            }
            else if (rec.type == "info" || rec.type == "info_report" || rec.type == "info_msg")
            {
               recClass = "info";
            }
            $("#lv_records").append($("<tr class=\"" + recClass + "\"><td>" + rec.no + "</td><td>" + rec.type + "</td><td>" + rec.pid + "</td><td>"
                  + rec.date + "</td></tr>").click(function()
            {
               $.post("/get_record", rec.no, function(res){
                  var body = $("body", top.frames[1].document);
                  body.children().remove();
                  body.append(res);
               });
            }));
         });
      }
      function get_selected_types()
      {
         var res ="[";
         var len = $("#lv_types input").length;
         $("#lv_types input").each(function(i, t)
         {
            if (t.checked == true)
            {
               if (res != "[")
               {
                  res += ",";
               }
               res = res + t.value;
            }
         });
         return res + "]";
      }
      function get_records(page)
      {
         var grep = $("#lv_grep").val();
         var recOnPage = $("#lv_rec_on_page").val();
         var selTypes = get_selected_types();
         var tuple = "{\"" + grep + "\"," + page + "," + recOnPage + "," + selTypes + "}.";
         $.post("/get_records", tuple, function(res)
         {
            var data = jQuery.parseJSON(res);
            //apply_types(data.types);
            apply_pages(data.pages, page);
            apply_records(data.records);
         });
      }
      function rescan()
      {
         var maxRecords = $("#lv_max_records").val();
         var grep = $("#lv_grep").val();
         var recOnPage = $("#lv_rec_on_page").val();
         var tuple = "{\"" + grep + "\"," + recOnPage + ",all," + maxRecords + "}.";
         $.post("/rescan", tuple, function(res)
         {
            var data = jQuery.parseJSON(res);
            apply_types(data.types);
            apply_pages(data.pages, "1");
            apply_records(data.records);
         });
      }
      $(document).ready(function(){
         rescan("all");
         $("#lv_rescan").click(function()
         {
            rescan(get_selected_types());
         });
         $("#lv_apply").click(function()
         {
            get_records("1");
         });
      });
      </script>
   </head>
   <body>
      <p>
         <label for="lv_max_records">Max records</label>
         <select id="lv_max_records">
            <option>100</option>
            <option>500</option>
            <option>1000</option>
            <option>all</option>
         </select>
         <button id="lv_rescan">Rescan</button>
      </p>
      <p>
         <label for="lv_grep">Grep</label>
         <input id="lv_grep" type = "text">
         <label for="lv_rec_on_page">Records on page</label>
         <select id="lv_rec_on_page">
            <option>30</option>
            <option>50</option>
            <option>100</option>
         </select>
         <button id="lv_apply">Apply</button>
      </p>
      <p id="lv_types"></p>
      <p class="pages" id="lv_pages"></p>
      <table class="records" id="lv_records"/>
   </body>
</html>